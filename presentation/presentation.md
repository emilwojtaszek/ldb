# [FIT]*protobuf*
# __and__
# [FIT]*leveldb*

---

#Our story with   
#**Messaging App**

###- XMPP
###- LAYER
.
.
####but client was unhappy...

---

#[fit] idea?
# ...custom **protocol**

---

## requirements: 
##[FIT]**FAST**
##and 
##[FIT]_multiplatform_ 

---

## Let's try... 

# __*protobuf*__ and __*leveldb*__

---

# *protobuf*

# __Google's__ _data_
# _interchange format_

---

# [fit]One __common__ 
# [fit]file for everyone
# (proto files)

---

# [fit]Auto __generate__
# [fit]code for __multiple__ 
# [fit]platforms

---

# [fit]__Fast__
## [fit]_coding_ and
## [fit]_decoding_

---

# [fit]Small
# [fit]payload

---

# [fit]Final code 
# [fit]is __easy__ to read and
# [fit] well __commented__

---
# Example proto file:

---


```
package presence;

// Message generated by server when someone of our contacts change connection state
//
// This message has to be send to client after client connected to server
// Server should also notify for status of all participants in conversations
message PresenceServerMessage {
  required string user_id = 1;

  // presence of user (required)
  oneof presence {
    Online online = 2;
    Offline offline = 3;
  }

  // when at least one device is currently connected to websocket and it is `SetPresenceClientMessage.Available`
  message Online {
  }

  // If last user device was disconnected from websocket or changed status to `SetPresenceClientMessage.Unavailable`
  message Offline {
     required int64 last_seen_in_millis = 1; // last seen time in milliseconds
  }
}
```

---

# __*leveldb*__

# is a fast key-value storage library
---

# provides an __ordered__ mapping from string _keys_ to string _values_

---

# ...and is super easy:
# [fit] __*get*__
# [fit] __*put*__
# [fit] __*delete*__

---
Example

```
// create database
LevelDB *ldb = [LevelDB databaseInLibraryWithName:@"test.ldb"];

// add/update object for key 
[ldb setObject:@"value1" forKey:@"key1"];

// get object for key
NSLog(@"%@", [snap objectForKey:@"string_test"]);

// remove object
[ldb removeObjectForKey:@"key1"];

```

---
Enumeration:

```
[ldb enumerateKeysAndObjectsUsingBlock:
^(LevelDBKey *key, id value, BOOL *stop) {

}];

or

[ldb enumerateKeysAndObjectsBackward:NO
                              lazily:NO
                       startingAtKey:startKey // start key
                 filteredByPredicate:predicate // predicate for values
                           andPrefix:prefix // key prefix
                          usingBlock:^(LevelDBKey *key, id value, BOOL *stop) {

}]

```

---
Structure:

```
k: field:animal:box:1:kind:tiger   ->  v: value1
k: field:animal:box:2:kind:cow     ->  v: value2
k: field:animal:box:2:kind:snake   ->  v: value3
k: field:food:container:1:meat     ->  v: value4
k: field:food:container:2:grass    ->  v: value5
```

---

# Write performance

```
				| 10    | 100   | 1,000 | 10,000 |
|--------------	|-------|-------|-------|--------|
| CodeData (t) 	| 0.015 | 0.027 | 0.072 | 2.030  |
| CodeData     	| 0.090 | 0.916 | 9.247 | 94.014 |
| LDB (t)      	| 0.068 | 0.083 | 0.297 | 2.384  |
| LDB          	| 0.064 | 0.084 | 0.318 | 2.852  |
| Realm (t)    	| 0.146 | 0.197 | 0.453 | 1.099  |
```

---

# Read performance

```
           | 1        | 0-100 | 100-200 |
|----------|----------|-------|---------|
| Realm    | 0.000199 | 0.004 | 0.003   |
| LDB      | 0.000124 | 0.004 | 0.005   |
| CoreData | 0.001012 | 0.004 | 0.007   |
```

---

# Messaging Example...

---

#__Thanks!__


#www.AppUnite.com

##_Emil Wojtaszek_
##_≈Åukasz Kasperek_

